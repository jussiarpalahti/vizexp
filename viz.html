<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.8/d3.min.js" type="text/JavaScript"></script>
    <script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
    <script src="assets/colorbrewer.js"></script>
    <title>Maakuntien rajat</title>
  </head>
  <body>
    <h1>Maakuntien rajat</h1>
    <div id="viz">
      <svg style="width:600px;height:600px;" ></svg>
    </div>
    <script>

      //
      // Data setup
      //

      let y1994 = {
        'Ahvenanmaan lääni': '14',
        'Hämeen lääni': '2745',
        'Keski-suomen lääni': '972',
        'Kuopion lääni': '763',
        'Kymen lääni': '793',
        'Lapin lääni': '24976',
        'Mikkelin lääni': '498',
        'Oulun lääni': '481',
        'Pohjois-karjalan lääni': '695',
        'Turun ja porin lääni': '1723',
        'Uudenmaan lääni': '14045',
        'Vaasan lääni': '923',
        'Viipurin lääni': '1324'
      };

      let classifications = [ 100, 500, 1000, 2000, 5000, 15000, Number.POSITIVE_INFINITY]; // ..and beyond

      let colors = colorbrewer.Reds[7];
      
      let darker = (color) => d3.rgb(color).darker();

      let classes = {};
      Object.keys(y1994).forEach(
        (key) => {
          for (let [index, limit] of classifications.entries()) {
            if (y1994[key] < limit) {
              classes[key] = index;
              break;
            }
          }
        }
      );
      
      // 
      // Map setup 
      // 
      
      var PromiseWrapper = (xhr, d) => new Promise(resolve => xhr(d, (p) => resolve(p)));

      Promise
        .all([
          PromiseWrapper(d3.json, "data/laanit.geojson"),
        ])
        .then(resolve => {
          createMap(resolve[0]);
        });

      function createMap(geojson) {
        
        var width = 800,
            height = 600;
        
        var svg = d3.select("svg");

        var projection = d3.geoTransverseMercator().fitSize([width, height], geojson)
                           .rotate([-27,-65,0])
                           .translate([width/2, height/2])
                           .scale([3300]);

        var path = d3.geoPath().projection(projection);
        
        var g = svg.append("g")
                   .style("stroke-width", "1.5px");

        g.selectAll('path')
          .data(geojson.features)
          .enter()
          .append('path')
          .attr('d', path)
          .style("fill", d => {
              if (d.properties.LAANI === 'HELSINKI') return "crimson";
              else {
                let name = d.properties.LAANI.charAt(0) + d.properties.LAANI.toLowerCase().slice(1);
                return colors[classes[name]];
              }
            })
          .style("stroke-width", d => d.properties.nimi === 'Helsinki' ? "3" : "1")
          .style("stroke", d => {
            let name = d.properties.LAANI.charAt(0) + d.properties.LAANI.toLowerCase().slice(1);
            if (name === 'Helsinki') {
              return "white"
            }
            else if (name === 'Uusimaa') {
              return "none"
            }
            else {
              return darker(colors[classes[name]]);
            }
          });
        }

    </script>
  </body>
</html>
