<!doctype html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="css/hel-bootstrap-3-1.0.0-beta.4.css">
    <link rel="stylesheet" href="css/hel-elements.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.8/d3.min.js" type="text/JavaScript"></script>
    <script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
    <script src="assets/colorbrewer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.9.0/bootstrap-slider.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.9.0/css/bootstrap-slider.min.css">

    <link rel="stylesheet" href="css/styling.css">
    <style type="text/css">
      /*body {*/
        /*background-color: black;*/
      /*}*/
      /*body * {*/
        /*color: #eff3ff;*/
      /*}*/
      button {
        color: black;
        background: cadetblue;
      }
    </style>
    <title>Helsinkiin muuttaneet lääneittäin ja maakunnittain 1917-2016</title>
  </head>

  <body style="background-color: #eee;">
  <header>
    <nav class="navbar navbar-fixed-top navbar-default" role="navigation">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button data-target=".navbar-collapse" data-toggle="collapse" class="navbar-toggle" type="button">
            <span class="sr-only">Valikko</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="#site-root" class="navbar-brand" title="Site Title" data-placement="bottom">
            Helsinkiin muuttaneet lääneittäin ja maakunnittain 1917-2016
          </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!--<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">-->
          <!--<ul class="nav navbar-nav">-->
            <!--<li class="">-->
              <!--<a href="#pageurl">First page</a>-->
            <!--</li>-->
            <!--<li class="">-->
              <!--<a href="#pageurl">Second page</a>-->
            <!--</li>-->
          <!--</ul>-->
        <!--</div>-->
      </div>
    </nav>
  </header>

  <!-- Use <main> landmark to help screenreaders -->
  <div class="push-footer">
    <main>
      <!-- hero section with background image -->
      <section class="sesction--site-hero bg-cover-image" style="background-image: url('https://source.unsplash.com/5Rgr_zI7pBw');">
        <div class="container">
          <div class="row">
            <img src="images/helsinki-logo-white.svg" class="hero-logo">
          </div>
          <div class="col-sm-10 col-md-8 col-lg-7 hero-content">
            <h2><img id="suomi100logo" src="assets/SuomiFinland100-tunnus_valkoinen_RGB.jpg" alt="Suomi 100"></h2>
            <h3>Helsinkiin muuttaneet lääneittäin ja maakunnittain 1917-2016</h3>
          </div>
        </div>
      </section>
      <!-- content section with background color -->
      <section class="section--content bg-hel-fog">
        <div class="container">
          <div class="row">
            <div class="col-xs-8 col-lg-5">
              <div id="viz"><svg style="width:350px; height:500px;" ></svg></div>
              <div id="animate"><button>Animaatio</button></div>
              <div id="sliideri" style="margin: 3em; width: 30em;">
                <input type="text" id="slider">
              </div>
            </div>
            <div class="col-xs-4">
              <div id="legend"></div>
            </div>
          </div>
        </div>
      </section>
      <section class="section--content bg-hel-metro">
        <div class="container">

        </div>
      </section>
    </main>
  </div>

  <!-- Site footer -->
  <footer class="site-footer">
    <div class="container">
      <div class="row">
        <div class="col-md-3 col-md-push-6 col-sm-4 col-sm-push-4">
        </div>
        <div class="col-md-3 col-md-pull-3 col-sm-4 col-sm-pull-4">
          <div class="footer-branding footer-branding-helsinki">
            <a href="http://www.hel.fi">
              <img alt="Helsingin tunnus" src="images/helsinki-logo-white.svg" class="footer-logo footer-logo-helsinki" aria-hidden="true">
            </a>
          </div>
        </div>
        <div class="col-md-3 col-md-push-3 col-sm-4">
          <div class="page-footer-block">
            <ul class="footer-links">
              <li></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12">
          <div class="site-footer-small-print">
            <ul class="small-print-nav list-inline">
              <li><a href="#yhteystiedot">Ota yhteyttä</a></li>
              <li>2017 Helsingin kaupunki</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Including Bootstrap JS (with its jQuery dependency) so that dynamic components work -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

  <script>

      //
      // Data setup
      //
      let maps, data;
      let start_year = 1917;
      let end_year = 2016;

      let classifications = [100, 500, 1000, 2000, 5000, 15000, Number.POSITIVE_INFINITY]; // ..and beyond
      let explanations = ['alle 100', '100 - 500', '500 - 1 000', '1 000 - 2 000', '2 000 - 5 000', '5 000 - 15 000', 'yli 15 000'];

      let map_names = [
          'data/Laanit_1917_1920_1.geojson',
          'data/Laanit_1921_1937_2.geojson',
          'data/Laanit_1938_1940_3.geojson',
          'data/Laanit_1941_1944_4.geojson',
          'data/Laanit_1945_1947_5.geojson',
          'data/Laanit_1948_1959_6.geojson',
          'data/Laanit_1960_1994_7.geojson',
          'data/Maakunnat_8.geojson'
      ];
      let map_ranges = [1921, 1938, 1941, 1945, 1948, 1960, 1995, Number.POSITIVE_INFINITY];

      let suomenlinna = "#F5A3C7";
      let colors = colorbrewer.Blues[7];
      
      let darker = (color) => d3.rgb(color).darker();

      function get_map_for_year(year) {
          let x;
          map_ranges.find((range, index) => {
              if (year < range) {
                  x = map_names[index];
                  return true;
              }
          });
          return x;
      }

      //
      // Fetching maps and data
      //

      async function loader() {

        let maps = {};

        map_names.forEach(async function (name) {
            let res = await fetch(name);
            let map = await res.json();
            maps[name] = map;
        });

        let r2 = await fetch('data/laanit.csv');
        let laanit_text = await r2.text();
        let laanit_list = [];
        d3.dsvFormat(';').parse(laanit_text, (d) => laanit_list.push(d));
        let laanit = {};
        laanit_list.forEach(
              (item) => {
                  const y = item["VUOSI"];
                  laanit[y] = _.omit(item, ['VUOSI', 'Yhteensä', ""]);
                  laanit[y]['map'] = get_map_for_year(y);
              }
        );

        let r3 = await fetch('data/maakunnat.csv');
        let maakunnat_text = await r3.text();
        let maakunnat_list = [];
        d3.dsvFormat(';').parse(maakunnat_text, (d) => maakunnat_list.push(d));
        let maakunnat = {};
        maakunnat_list.forEach(
            (item) => {
                const y = item["VUOSI"];
                maakunnat[y] = _.omit(item, ['VUOSI', 'Yhteensä', ""]);
                maakunnat[y]['map'] = get_map_for_year(y);
            }
        );

        let data = {};
        Object.assign(data, laanit);
        Object.assign(data, maakunnat);

        return {maps, data};

      }

      //
      // Map setup
      //

      function createMap(geojson, data) {
        let classes = {};
        Object.keys(data).forEach(
            (key) => {

                // Empty data for this space
                if (data[key] === "") {
                    classes[key] = null;
                    return
                }

                for (let [index, limit] of classifications.entries()) {
                    if (data[key] < limit) {
                        classes[key] = index;
                        break;
                    }
                }
            }
        );

        var width = 350,
            height = 500;

        var svg = d3.select("#viz svg");
        svg.selectAll("*").remove();

        var projection = d3.geoTransverseMercator().fitSize([width, height], geojson)
                           .rotate([-27,-65,0])
                           .translate([(width/2) + 30, height/2])
                           .scale([2802]);

        var path = d3.geoPath().projection(projection);
        
        var g = svg.append("g")
                   .style("stroke-width", "1.5px");

        g.selectAll('path')
          .data(geojson.features)
          .enter()
          .append('path')
          .attr('d', path)
          .style("fill", d => {
              if (d.properties.nimi === 'HELSINKI') return suomenlinna; // Suomenlinna
              else if (classes[d.properties.nimi] !== null) {
                return colors[classes[d.properties.nimi]];
              }
            })
          .style("stroke-width", d => d.properties.nimi === 'HELSINKI' ? "3" : "1")
          .style("stroke", d => {
            switch (d.properties.nimi) {
              case 'HELSINKI':
                return darker(suomenlinna);
              case 'UUDENMAAN LÄÄNI':
                return "none";
              default:
                return "white";
            }
          })
          .append("title").text(d => {
              if (d.properties.nimi === 'HELSINKI') return "suomenlinna"; // Suomenlinna
              else if (classes[d.properties.nimi] !== null) {
                  return d.properties.nimi + " " + data[d.properties.nimi];
              }
          })
        ;
        }

      async function render(year) {
          let res = await loader();
          maps = res["maps"];
          data = res["data"];
          // Instantiate a slider
          let stuff = _.flatten([
              start_year,
              _.range(start_year, end_year).filter(v => v % 10 === 0),
              end_year
          ]);
          let years = _.range(start_year, end_year);
          let mySlider = new Slider("input#slider", {
              ticks: stuff,
              ticks_labels: stuff,
              ticks_positions: [0, 5, 15, 25, 35, 45, 55, 65, 75, 85, 93, 100],
              min: start_year,
              max: end_year
          });

          mySlider.on('change', v => set_year(v.newValue));

          let animate;

          function advancer(num) {
              if (animate && num < end_year) {
                  mySlider.setValue(num, true, true);
                  setTimeout(() => {
                      advancer(num + 1);
                  }, 500);
              }
          }

          d3.select('#animate button')
              .on('click', function () {
                  console.log("hrm", this);
                  if (animate) {
                      animate = false;
                      d3.select(this).text('Animaatio');
                  } else {
                      animate = true;
                      d3.select(this).text('Stop');
                  }
                  advancer(year);
              });

          make_legend();

          createMap(maps[data[year]["map"]], data[year]);
        }

      function make_legend () {
          d3.select('div#legend')
              .selectAll('span')
              .data(colors)
              .enter()
              .append('span')
              .attr('style', d => 'background-color:' + d)
              .text((d, i) => explanations[i]);
      }

      function set_year(year) {
          createMap(maps[data[year]["map"]], data[year]);
      }

      render(start_year);

    </script>
  </body>
</html>
