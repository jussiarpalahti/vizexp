<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.8/d3.min.js" type="text/JavaScript"></script>
    <script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
    <script src="assets/colorbrewer.js"></script>
    <style type="text/css">
      /*body {*/
        /*background-color: black;*/
      /*}*/
      /*body * {*/
        /*color: #eff3ff;*/
      /*}*/
    </style>
    <title>Maakuntien rajat</title>
  </head>
  <body>
    <h1>Maakuntien rajat</h1>
    <div>
        <svg style="width:400px; height:600px;" ></svg>
    </div>
    <script>

      //
      // Data setup
      //
      let maps, data;
      let year = 1917;

      let classifications = [100, 500, 1000, 2000, 5000, 15000, Number.POSITIVE_INFINITY]; // ..and beyond

      let map_names = [
          'data/Laanit_1917_1920_1.geojson',
          'data/Laanit_1921_1937_2.geojson',
          'data/Laanit_1938_1940_3.geojson',
          'data/Laanit_1941_1944_4.geojson',
          'data/Laanit_1945_1947_5.geojson',
          'data/Laanit_1948_1959_6.geojson',
          'data/Laanit_1960_1994_7.geojson',
          'data/Maakunnat_8.geojson'
      ];
      let map_ranges = [1921, 1938, 1941, 1945, 1948, 1960, 1995, Number.POSITIVE_INFINITY];

      let suomenlinna = "#F5A3C7";
      let colors = colorbrewer.Blues[7];
      
      let darker = (color) => d3.rgb(color).darker();

      function get_map_for_year(year) {
          let x;
          map_ranges.find((range, index) => {
              if (year < range) {
                  x = map_names[index];
                  return true;
              }
          });
          return x;
      }

      //
      // Fetching maps and data
      //

      async function loader() {

        let maps = {};

        map_names.forEach(async function (name) {
            let res = await fetch(name);
            let map = await res.json();
            maps[name] = map;
        });

        let r2 = await fetch('data/laanit.csv');
        let laanit_text = await r2.text();
        let laanit_list = [];
        d3.dsvFormat(';').parse(laanit_text, (d) => laanit_list.push(d));
        let laanit = {};
        laanit_list.forEach(
              (item) => {
                  const y = item["VUOSI"];
                  laanit[y] = _.omit(item, ['VUOSI', 'Yhteensä', ""]);
                  laanit[y]['map'] = get_map_for_year(y);
              }
        );

        let r3 = await fetch('data/maakunnat.csv');
        let maakunnat_text = await r3.text();
        let maakunnat_list = [];
        d3.dsvFormat(';').parse(maakunnat_text, (d) => maakunnat_list.push(d));
        let maakunnat = {};
        maakunnat_list.forEach(
            (item) => {
                const y = item["VUOSI"];
                maakunnat[y] = _.omit(item, ['VUOSI', 'Yhteensä', ""]);
                maakunnat[y]['map'] = get_map_for_year(y);
            }
        );

        let data = {};
        Object.assign(data, laanit);
        Object.assign(data, maakunnat);

        return {maps, data};

      }

      //
      // Map setup
      //

      function createMap(geojson, data) {
        let classes = {};
        Object.keys(data).forEach(
            (key) => {

                // Empty data for this space
                if (data[key] === "") {
                    classes[key] = null;
                    return
                }

                for (let [index, limit] of classifications.entries()) {
                    if (data[key] < limit) {
                        classes[key] = index;
                        break;
                    }
                }
            }
        );

        var width = 400,
            height = 600;

        var svg = d3.select("svg");
        svg.selectAll("*").remove();

        var projection = d3.geoTransverseMercator().fitSize([width, height], geojson)
                           .rotate([-27,-65,0])
                           .translate([(width/2) + 30, height/2])
                           .scale([3300]);

        var path = d3.geoPath().projection(projection);
        
        var g = svg.append("g")
                   .style("stroke-width", "1.5px");

        g.selectAll('path')
          .data(geojson.features)
          .enter()
          .append('path')
          .attr('d', path)
          .style("fill", d => {
              if (d.properties.nimi === 'HELSINKI') return suomenlinna; // Suomenlinna
              else if (classes[d.properties.nimi] !== null) {
                return colors[classes[d.properties.nimi]];
              }
            })
          .style("stroke-width", d => d.properties.nimi === 'HELSINKI' ? "3" : "1")
          .style("stroke", d => {
            switch (d.properties.nimi) {
              case 'HELSINKI':
                return darker(suomenlinna);
              case 'UUDENMAAN LÄÄNI':
                return "none";
              default:
                return "white";
            }
          })
          .append("title").text(d => {
              if (d.properties.nimi === 'HELSINKI') return "suomenlinna"; // Suomenlinna
              else if (classes[d.properties.nimi] !== null) {
                  console.log("data", data[d.properties.nimi]);
                  return d.properties.nimi + " " + data[d.properties.nimi];
              }
          })
        ;
        }

      async function render(year) {
          if (!maps && !data) {
              let res = await loader();
              maps = res["maps"];
              data = res["data"];
          }
          createMap(maps[data[year]["map"]], data[year]);
        }

      function set_year(year) {
        render(year);
      }

      render(year);

    </script>
    <button onclick="set_year(1917)">1917</button>
    <button onclick="set_year(1918)">1918</button>
    <button onclick="set_year(1919)">1919</button>
    <button onclick="set_year(1920)">1920</button>
    <button onclick="set_year(1921)">1921</button>
    <button onclick="set_year(1922)">1922</button>
    <button onclick="set_year(1923)">1923</button>
    <button onclick="set_year(1924)">1924</button>
    <button onclick="set_year(1925)">1925</button>
    <button onclick="set_year(1926)">1926</button>
    <button onclick="set_year(1927)">1927</button>
    <button onclick="set_year(1928)">1928</button>
    <button onclick="set_year(1929)">1929</button>
    <button onclick="set_year(1930)">1930</button>
    <button onclick="set_year(1931)">1931</button>
    <button onclick="set_year(1932)">1932</button>
    <button onclick="set_year(1933)">1933</button>
    <button onclick="set_year(1934)">1934</button>
    <button onclick="set_year(1935)">1935</button>
    <button onclick="set_year(1936)">1936</button>
    <button onclick="set_year(1937)">1937</button>
    <button onclick="set_year(1938)">1938</button>
    <button onclick="set_year(1939)">1939</button>
    <button onclick="set_year(1940)">1940</button>
    <button onclick="set_year(1941)">1941</button>
    <button onclick="set_year(1942)">1942</button>
    <button onclick="set_year(1943)">1943</button>
    <button onclick="set_year(1944)">1944</button>
    <button onclick="set_year(1945)">1945</button>
    <button onclick="set_year(1946)">1946</button>
    <button onclick="set_year(1947)">1947</button>
    <button onclick="set_year(1948)">1948</button>
    <button onclick="set_year(1949)">1949</button>
    <button onclick="set_year(1950)">1950</button>
    <button onclick="set_year(1951)">1951</button>
    <button onclick="set_year(1952)">1952</button>
    <button onclick="set_year(1953)">1953</button>
    <button onclick="set_year(1954)">1954</button>
    <button onclick="set_year(1955)">1955</button>
    <button onclick="set_year(1956)">1956</button>
    <button onclick="set_year(1957)">1957</button>
    <button onclick="set_year(1958)">1958</button>
    <button onclick="set_year(1959)">1959</button>
    <button onclick="set_year(1960)">1960</button>
    <button onclick="set_year(1961)">1961</button>
    <button onclick="set_year(1962)">1962</button>
    <button onclick="set_year(1963)">1963</button>
    <button onclick="set_year(1964)">1964</button>
    <button onclick="set_year(1965)">1965</button>
    <button onclick="set_year(1966)">1966</button>
    <button onclick="set_year(1967)">1967</button>
    <button onclick="set_year(1968)">1968</button>
    <button onclick="set_year(1969)">1969</button>
    <button onclick="set_year(1970)">1970</button>
    <button onclick="set_year(1971)">1971</button>
    <button onclick="set_year(1972)">1972</button>
    <button onclick="set_year(1973)">1973</button>
    <button onclick="set_year(1974)">1974</button>
    <button onclick="set_year(1975)">1975</button>
    <button onclick="set_year(1976)">1976</button>
    <button onclick="set_year(1977)">1977</button>
    <button onclick="set_year(1978)">1978</button>
    <button onclick="set_year(1979)">1979</button>
    <button onclick="set_year(1980)">1980</button>
    <button onclick="set_year(1981)">1981</button>
    <button onclick="set_year(1982)">1982</button>
    <button onclick="set_year(1983)">1983</button>
    <button onclick="set_year(1984)">1984</button>
    <button onclick="set_year(1985)">1985</button>
    <button onclick="set_year(1986)">1986</button>
    <button onclick="set_year(1987)">1987</button>
    <button onclick="set_year(1988)">1988</button>
    <button onclick="set_year(1989)">1989</button>
    <button onclick="set_year(1990)">1990</button>
    <button onclick="set_year(1991)">1991</button>
    <button onclick="set_year(1992)">1992</button>
    <button onclick="set_year(1993)">1993</button>
    <button onclick="set_year(1994)">1994</button>
    <button onclick="set_year(1995)">1995</button>
    <button onclick="set_year(1996)">1996</button>
    <button onclick="set_year(1997)">1997</button>
    <button onclick="set_year(1998)">1998</button>
    <button onclick="set_year(1999)">1999</button>
    <button onclick="set_year(2000)">2000</button>
    <button onclick="set_year(2001)">2001</button>
    <button onclick="set_year(2002)">2002</button>
    <button onclick="set_year(2003)">2003</button>
    <button onclick="set_year(2004)">2004</button>
    <button onclick="set_year(2005)">2005</button>
    <button onclick="set_year(2006)">2006</button>
    <button onclick="set_year(2007)">2007</button>
    <button onclick="set_year(2008)">2008</button>
    <button onclick="set_year(2009)">2009</button>
    <button onclick="set_year(2010)">2010</button>
    <button onclick="set_year(2011)">2011</button>
    <button onclick="set_year(2012)">2012</button>
    <button onclick="set_year(2013)">2013</button>
    <button onclick="set_year(2014)">2014</button>
    <button onclick="set_year(2015)">2015</button>
  </body>
</html>
