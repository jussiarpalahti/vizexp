<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.8/d3.min.js" type="text/JavaScript"></script>
    <script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
    <script src="assets/colorbrewer.js"></script>
    <style type="text/css">
      body {
        background-color: black;
      }
      body * {
        color: white;
      }
    </style>
    <title>Maakuntien rajat</title>
  </head>
  <body>
    <h1>Maakuntien rajat</h1>
    <div>
        <svg style="width:400px;height:600px;" ></svg>
    </div>
    <script>

      //
      // Data setup
      //
      let year = '1994';

      let data = {
          '1994' : {
            'AHVENANMAA': 14,
            'HÄMEEN LÄÄNI': 2745,
            'KESKI-SUOMEN LÄÄNI': 972,
            'KUOPION LÄÄNI': 763,
            'KYMEN LÄÄNI': 793,
            'LAPIN LÄÄNI': 24976,
            'MIKKELIN LÄÄNI': 498,
            'OULUN LÄÄNI': 481,
            'POHJOIS-KARJALAN LÄÄNI': 695,
            'TURUN JA PORIN LÄÄNI': 1723,
            'UUDENMAAN LÄÄNI': 14045,
            'VAASAN LÄÄNI': 923,
            'VIIPURIN LÄÄNI': 1324
          }
      };

      let classifications = [100, 500, 1000, 2000, 5000, 15000, Number.POSITIVE_INFINITY]; // ..and beyond

      let suomenlinna = "#F5A3C7";
      let colors = colorbrewer.Blues[7];
      
      let darker = (color) => d3.rgb(color).darker();
      
      // 
      // Map setup 
      //
      
      async function loader() {

        let r1 = await fetch("data/Laanit_1960_1994_7.geojson");
        let map_laanit = await r1.json();

        let r2 = await fetch('data/laanit.csv');
        let laanit_text = await r2.text();
        let laanit = [];
        d3.dsvFormat(';').parse(laanit_text, (d) => laanit.push(d));

        let r3 = await fetch('data/maakunnat.csv');
        let maakunnat_text = await r3.text();
        let maakunnat = [];
        d3.dsvFormat(';').parse(maakunnat_text, (d) => maakunnat.push(d));

        let r4 = await fetch("data/Maakunnat_wgs84.geojson");
        let map_maakunnat = await r4.json();

        return {map_laanit, laanit, maakunnat, map_maakunnat};

      }

      function createMap(geojson, data) {

        let classes = {};
        Object.keys(data).forEach(
            (key) => {

                // Year is currently embedded into data object
                if (key === 'VUOSI') return;

                // Empty data for this space
                if (data[key] === "") {
                    classes[key] = null;
                    return
                }

                for (let [index, limit] of classifications.entries()) {
                    if (data[key] < limit) {
                        classes[key] = index;
                        break;
                    }
                }
            }
        );

        var width = 400,
            height = 600;
        
        var svg = d3.select("svg");

        var projection = d3.geoTransverseMercator().fitSize([width, height], geojson)
                           .rotate([-27,-65,0])
                           .translate([(width/2) + 30, height/2])
                           .scale([3300]);

        var path = d3.geoPath().projection(projection);
        
        var g = svg.append("g")
                   .style("stroke-width", "1.5px");

        g.selectAll('path')
          .data(geojson.features)
          .enter()
          .append('path')
          .attr('d', path)
          .style("fill", d => {
              if (d.properties.LAANI === 'HELSINKI') return suomenlinna; // Suomenlinna
              else if (classes[d.properties.LAANI]) {
                return colors[classes[d.properties.LAANI]];
              }
            })
          .style("stroke-width", d => d.properties.LAANI === 'HELSINKI' ? "3" : "1")
          .style("stroke", d => {
            switch (d.properties.LAANI) {
              case 'HELSINKI':
                return darker(suomenlinna);
              case 'UUDENMAAN LÄÄNI':
                return "none";
              default:
                return "white";
            }
          });
        }

      async function render() {
            let {map_laanit, laanit, maakunnat, map_maakunnat} = await loader();
            createMap(map_laanit, laanit[0]);
        }

      render();

    </script>
  </body>
</html>
